<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>QuickChat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
  <style>
    :root {
      --apple-bg: linear-gradient(135deg, #f5f5f7 0%, #e3e9f7 100%);
      --apple-panel: rgba(255,255,255,0.85);
      --apple-card: rgba(255,255,255,0.7);
      --apple-accent: #0071e3;
      --apple-accent-hover: #005bb5;
      --apple-accent-2: #3b82f6;
      --apple-danger: #ef4444;
      --apple-text: #1d1d1f;
      --apple-muted: #86868b;
      --mine: #0071e3;
      --theirs: #e5e5ea;
      --apple-border: #d2d2d7;
      --radius: 18px;
      --shadow: 0 4px 24px rgba(0,0,0,0.10);
      --blur: 18px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: var(--apple-bg);
      color: var(--apple-text);
      min-height: 100vh;
      transition: background 0.5s;
    }
    .apple-nav {
      background: var(--apple-panel);
      box-shadow: var(--shadow);
      padding: 0 32px;
      height: 56px;
      display: flex;
      align-items: center;
      font-size: 22px;
      font-weight: 700;
      border-bottom: 1px solid var(--apple-border);
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(var(--blur));
      letter-spacing: -0.03em;
    }
    .apple-logo {
      color: var(--apple-accent);
      font-family: inherit;
      font-weight: 700;
      font-size: 28px;
      letter-spacing: -0.04em;
      text-shadow: 0 2px 8px #0071e322;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .apple-logo .logo-box {
      display: inline-block;
      width: 32px;
      height: 32px;
      background: var(--apple-accent);
      color: #fff;
      border-radius: 8px;
      font-size: 22px;
      font-weight: 900;
      text-align: center;
      line-height: 32px;
      letter-spacing: 0;
      margin-right: 8px;
      box-shadow: 0 2px 8px #0071e322;
    }
    #app {
      display: grid;
      grid-template-columns: 340px 1fr;
      width: 100%;
      min-height: calc(100vh - 56px);
      max-width: 1400px;
      margin: 0 auto;
      background: transparent;
      transition: opacity 0.5s;
    }
    .sidebar {
      background: transparent;
      border-right: 1px solid var(--apple-border);
      padding: 32px 24px 24px 24px;
      overflow-y: auto;
      min-height: calc(100vh - 56px);
    }
    .card {
      background: var(--apple-card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 1px solid var(--apple-border);
      padding: 24px;
      margin-bottom: 32px;
      transition: box-shadow 0.2s, background 0.3s;
      animation: fadeinUp 0.7s;
      backdrop-filter: blur(var(--blur));
    }
    @keyframes fadeinUp {
      from { opacity: 0; transform: translateY(40px);}
      to { opacity: 1; transform: translateY(0);}
    }
    .card:focus-within, .card:hover {
      box-shadow: 0 8px 32px rgba(0,0,0,0.14);
      background: rgba(255,255,255,0.85);
    }
    .me-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .me-username { font-weight: 700; font-size: 18px; }
    .me-email { color: var(--apple-muted); font-size: 13px; }
    .field { margin: 12px 0; }
    .field label { display: block; font-size: 13px; color: var(--apple-muted); margin-bottom: 6px; }
    .field input {
      width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--apple-border);
      background: #f9f9fa; color: var(--apple-text); font-size: 16px;
      transition: border 0.2s, box-shadow 0.2s;
      box-shadow: 0 1px 2px rgba(0,0,0,0.03);
    }
    .field input:focus { border-color: var(--apple-accent); outline: none; box-shadow: 0 2px 8px #0071e322;}
    .btn {
      border: none; padding: 12px 20px; border-radius: 10px; cursor: pointer; color: #fff;
      background: var(--apple-accent-2); font-size: 16px; font-weight: 500;
      transition: background 0.15s, box-shadow 0.2s, transform 0.2s;
      margin-top: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      position: relative;
      overflow: hidden;
    }
    .btn.primary { background: var(--apple-accent); }
    .btn.primary:hover { background: var(--apple-accent-hover); transform: translateY(-2px) scale(1.04);}
    .btn.danger { background: var(--apple-danger); }
    .btn.ghost {
      background: transparent; border: 1px solid var(--apple-border); color: var(--apple-muted);
    }
    .btn.small { font-size: 13px; padding: 7px 12px; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn::after {
      content: "";
      position: absolute;
      left: 50%; top: 50%;
      width: 0; height: 0;
      background: rgba(255,255,255,0.2);
      border-radius: 100%;
      transform: translate(-50%,-50%);
      transition: width 0.3s, height 0.3s;
      z-index: 0;
    }
    .btn:active::after {
      width: 120%; height: 120%;
      transition: 0s;
    }
    .divider { text-align: center; color: var(--apple-muted); font-size: 13px; margin: 12px 0; }
    .list { display: grid; gap: 10px; }
    .user-item {
      background: #f9f9fa; border: 1px solid var(--apple-border); padding: 14px; border-radius: 12px; cursor: pointer;
      transition: border 0.2s, box-shadow 0.2s, background 0.2s;
      font-size: 16px;
      animation: fadeinUp 0.5s;
    }
    .user-item:hover { border-color: var(--apple-accent); box-shadow: 0 2px 8px rgba(0,0,0,0.04); background: #e3e9f7;}
    .user-name { font-weight: 600; }
    .main { display: grid; grid-template-rows: auto 1fr auto; background: transparent;}
    .chat-header {
      border-bottom: 1px solid var(--apple-border);
      padding: 24px 32px 16px 32px; display: flex; align-items: center; justify-content: space-between;
      background: var(--apple-panel);
      font-size: 20px;
      font-weight: 600;
      border-radius: 0 0 var(--radius) var(--radius);
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 5;
      backdrop-filter: blur(var(--blur));
    }
    .chat-title { font-weight: 700; font-size: 20px; }
    .typing { color: var(--apple-muted); font-size: 14px; margin-top: 4px; }
    .status { color: var(--apple-muted); font-size: 14px; }
    .messages-area {
      padding: 24px 32px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px;
      background: transparent;
      min-height: 400px;
      animation: fadeinUp 0.7s;
    }
    #btn-load-more { align-self: center; }
    .messages { display: flex; flex-direction: column; gap: 12px; }
    .msg {
      max-width: 70%; padding: 14px 18px; border-radius: var(--radius);
      display: inline-flex; flex-direction: column; gap: 8px; position: relative;
      font-size: 16px;
      box-shadow: var(--shadow);
      word-break: break-word;
      animation: fadeinUp 0.5s;
      background: rgba(255,255,255,0.8);
      backdrop-filter: blur(4px);
    }
    .msg.mine { align-self: flex-end; background: var(--mine); color: #fff; }
    .msg.theirs { align-self: flex-start; background: var(--theirs); color: var(--apple-text);}
    .msg .meta { font-size: 12px; color: #e2f1ff; opacity: 0.9; display: flex; gap: 8px; align-items: center; }
    .msg.mine .meta { color: #d2eaff; }
    .msg.theirs .meta { color: var(--apple-muted);}
    .msg .actions {
      position: absolute; top: -8px; right: -8px; display: none;
    }
    .msg:hover .actions { display: flex; }
    .msg .action-btn {
      background: #0008; border: 1px solid var(--apple-border); color: #fff; font-size: 12px;
      padding: 4px 8px; border-radius: 10px; cursor: pointer;
      box-shadow: 0 1px 2px rgba(0,0,0,0.08);
    }
    .msg .content { white-space: pre-wrap; }
    .composer {
      display: grid; grid-template-columns: 1fr auto auto; gap: 12px; padding: 24px 32px; border-top: 1px solid var(--apple-border);
      background: var(--apple-panel); border-radius: var(--radius) var(--radius) 0 0; box-shadow: var(--shadow);
      animation: fadeinUp 0.7s;
      position: relative;
      backdrop-filter: blur(var(--blur));
    }
    .composer input {
      width: 100%; padding: 14px; border-radius: 10px; border: 1px solid var(--apple-border);
      background: #f9f9fa; color: var(--apple-text); font-size: 16px;
      transition: border 0.2s;
    }
    .composer input:focus { border-color: var(--apple-accent); outline: none; }
    .emoji-picker {
      position: absolute;
      bottom: 60px;
      right: 40px;
      background: #fff;
      border: 1px solid var(--apple-border);
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      padding: 10px;
      display: none;
      z-index: 100;
      width: 220px;
      max-height: 180px;
      overflow-y: auto;
      font-size: 22px;
      gap: 8px;
      flex-wrap: wrap;
    }
    .emoji-picker span {
      cursor: pointer;
      padding: 4px;
      border-radius: 6px;
      transition: background 0.15s;
      display: inline-block;
    }
    .emoji-picker span:hover {
      background: #f0f0f0;
    }
    .welcome-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: calc(100vh - 56px);
      background: var(--apple-bg);
      animation: fadeinUp 1.2s;
    }
    .welcome-title {
      font-size: 60px;
      font-weight: 800;
      color: var(--apple-accent);
      margin-bottom: 18px;
      margin-top: 60px;
      letter-spacing: -0.03em;
      text-shadow: 0 2px 16px #0071e322;
      animation: fadeinUp 1.2s;
    }
    .welcome-desc {
      font-size: 24px;
      color: var(--apple-muted);
      margin-bottom: 32px;
      animation: fadeinUp 1.5s;
      text-align: center;
      max-width: 600px;
    }
    .welcome-btns {
      display: flex;
      gap: 18px;
      animation: fadeinUp 1.7s;
    }
    @media (max-width: 900px) {
      #app { grid-template-columns: 1fr; }
      .sidebar { display: none; }
      .main { border-radius: 0; }
      .chat-header, .messages-area, .composer { padding: 16px; }
      .welcome-title { font-size: 38px; }
      .welcome-desc { font-size: 18px; }
    }
    .hidden { display: none !important; }
    ::-webkit-scrollbar {
      width: 8px;
      background: var(--apple-bg);
    }
    ::-webkit-scrollbar-thumb {
      background: var(--apple-border);
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <nav class="apple-nav">
    <span class="apple-logo">QuickChat</span>
  </nav>
  <div id="welcome-section" class="welcome-section">
    <div class="welcome-title">Welcome to QuickChat</div>
    <div class="welcome-desc">Connect, chat, and share emojis instantly.<br>Start by logging in or creating an account.</div>
    <div class="welcome-btns">
      <button id="btn-show-login" class="btn primary">Login</button>
      <button id="btn-show-signup" class="btn">Signup</button>
    </div>
  </div>
  <div id="app" class="hidden">
    <!-- LEFT SIDEBAR -->
    <aside class="sidebar">
      <div id="login-section" class="card hidden">
        <h3 style="font-weight:600;font-size:20px;margin-bottom:8px;">Login</h3>
        <div class="field">
          <label>Username</label>
          <input id="login-username" type="text" placeholder="e.g. aryan" />
        </div>
        <div class="field">
          <label>Password</label>
          <input id="login-password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" />
        </div>
        <button id="btn-login" class="btn primary">Login</button>
        <div class="divider"><button id="btn-switch-signup" class="btn ghost small">Create account</button></div>
      </div>
      <div id="signup-section" class="card hidden">
        <h3 style="font-weight:600;font-size:20px;margin-bottom:8px;">Signup</h3>
        <div class="field">
          <label>Username</label>
          <input id="signup-username" type="text" placeholder="unique handle" />
        </div>
        <div class="field">
          <label>Email</label>
          <input id="signup-email" type="email" placeholder="you@example.com" />
        </div>
        <div class="field">
          <label>Password</label>
          <input id="signup-password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" />
        </div>
        <button id="btn-signup" class="btn primary">Create account</button>
        <div class="divider"><button id="btn-switch-login" class="btn ghost small">Back to login</button></div>
      </div>
      <div id="me-section" class="card hidden">
        <div class="me-row">
          <div>
            <div class="me-username" id="me-username">@me</div>
            <div class="me-email" id="me-email"></div>
          </div>
          <button id="btn-logout" class="btn danger small">Logout</button>
        </div>
        <div class="field">
          <label>Search users</label>
          <input id="search-input" type="text" placeholder="type to search..." />
        </div>
        <div id="users-list" class="list"></div>
      </div>
    </aside>
    <!-- MAIN CHAT AREA -->
    <main class="main">
      <header class="chat-header">
        <div>
          <div id="chat-title" class="chat-title">Select a user</div>
          <div id="typing-indicator" class="typing hidden">typingâ€¦</div>
        </div>
        <div id="status" class="status"></div>
      </header>
      <section class="messages-area">
        <button id="btn-load-more" class="btn ghost small hidden">Load more</button>
        <div id="messages" class="messages"></div>
      </section>
      <footer class="composer">
        <input id="message-input" type="text" placeholder="Type a messageâ€¦" disabled />
        <button id="btn-emoji" class="btn ghost" title="Insert emoji" style="padding:0 12px;font-size:22px;">ðŸ«§</button>
        <button id="btn-send" class="btn primary" disabled>Send</button>
        <div id="emoji-picker" class="emoji-picker"></div>
      </footer>
    </main>
  </div>
  <script>
    // =========================
    // CONFIG
    // =========================
    const SAME_ORIGIN = true;
    const API_BASE = SAME_ORIGIN ? '' : 'http://localhost:8080';
    const WS_URL   = SAME_ORIGIN ? '/ws' : 'http://localhost:8080/ws';
    const PAGE_SIZE = 20;
    // =========================
    // STATE
    // =========================
    let token = null;
    let stomp = null;
    let me = null;
    let currentPeer = null;
    let currentPage = 0;
    let lastLoadedPage = -1;
    let isLastPage = false;
    let messages = [];
    let typingTimer = null;
    // =========================
    // DOM
    // =========================
    const el = (id) => document.getElementById(id);
    const welcomeSection = el('welcome-section');
    const appSection = el('app');
    const loginSection = el('login-section');
    const signupSection = el('signup-section');
    const btnShowLogin = el('btn-show-login');
    const btnShowSignup = el('btn-show-signup');
    const btnSwitchSignup = el('btn-switch-signup');
    const btnSwitchLogin = el('btn-switch-login');
    const btnLogin       = el('btn-login');
    const btnSignup      = el('btn-signup');
    const btnLogout      = el('btn-logout');
    const meSection      = el('me-section');
    const meUsername     = el('me-username');
    const meEmail        = el('me-email');
    const searchInput    = el('search-input');
    const usersList      = el('users-list');
    const chatTitle      = el('chat-title');
    const typingIndicator= el('typing-indicator');
    const statusBar      = el('status');
    const btnLoadMore    = el('btn-load-more');
    const messagesBox    = el('messages');
    const messageInput   = el('message-input');
    const btnSend        = el('btn-send');
    const emojiBtn       = el('btn-emoji');
    const emojiPicker    = el('emoji-picker');
    // =========================
    // EMOJI PICKER (Apple style emojis)
    // =========================
    const EMOJIS = [
      "ðŸ˜€","ðŸ˜ƒ","ðŸ˜„","ðŸ˜","ðŸ˜†","ðŸ˜…","ðŸ˜‚","ðŸ¤£","ðŸ¥²","ðŸ˜Š","ðŸ˜‡","ðŸ™‚","ðŸ™ƒ","ðŸ˜‰","ðŸ˜Œ","ðŸ˜","ðŸ¥°","ðŸ˜˜","ðŸ˜—","ðŸ˜™","ðŸ˜š","ðŸ˜‹","ðŸ˜›","ðŸ˜","ðŸ˜œ","ðŸ¤ª","ðŸ¤¨","ðŸ§","ðŸ¤“","ðŸ˜Ž","ðŸ¥¸","ðŸ¤©","ðŸ¥³","ðŸ˜","ðŸ˜’","ðŸ˜ž","ðŸ˜”","ðŸ˜Ÿ","ðŸ˜•","ðŸ™","â˜¹ï¸","ðŸ˜£","ðŸ˜–","ðŸ˜«","ðŸ˜©","ðŸ¥º","ðŸ˜¢","ðŸ˜­","ðŸ˜¤","ðŸ˜ ","ðŸ˜¡","ðŸ¤¬","ðŸ¤¯","ðŸ˜³","ðŸ¥µ","ðŸ¥¶","ðŸ˜±","ðŸ˜¨","ðŸ˜°","ðŸ˜¥","ðŸ˜“","ðŸ¤—","ðŸ¤”","ðŸ¤­","ðŸ¤«","ðŸ¤¥","ðŸ˜¶","ðŸ˜","ðŸ˜‘","ðŸ˜¬","ðŸ™„","ðŸ˜¯","ðŸ˜¦","ðŸ˜§","ðŸ˜®","ðŸ˜²","ðŸ¥±","ðŸ˜´","ðŸ¤¤","ðŸ˜ª","ðŸ˜µ","ðŸ¤","ðŸ¥´","ðŸ¤¢","ðŸ¤®","ðŸ¤§","ðŸ˜·","ðŸ¤’","ðŸ¤•","ðŸ¤‘","ðŸ¤ ","ðŸ˜ˆ","ðŸ‘¿","ðŸ‘¹","ðŸ‘º","ðŸ¤¡","ðŸ’©","ðŸ‘»","ðŸ’€","â˜ ï¸","ðŸ‘½","ðŸ‘¾","ðŸ¤–"
    ];
    function renderEmojiPicker() {
      emojiPicker.innerHTML = '';
      EMOJIS.forEach(e => {
        const span = document.createElement('span');
        span.textContent = e;
        span.onclick = () => {
          messageInput.value += e;
          emojiPicker.style.display = 'none';
          messageInput.focus();
        };
        emojiPicker.appendChild(span);
      });
    }
    emojiBtn.addEventListener('click', (e) => {
      if (emojiPicker.style.display === 'block') {
        emojiPicker.style.display = 'none';
      } else {
        renderEmojiPicker();
        emojiPicker.style.display = 'block';
      }
    });
    document.addEventListener('click', (e) => {
      if (!emojiPicker.contains(e.target) && e.target !== emojiBtn) {
        emojiPicker.style.display = 'none';
      }
    });

    // =========================
    // PAGE FLOW
    // =========================
    function showWelcome() {
      welcomeSection.classList.remove('hidden');
      appSection.classList.add('hidden');
      loginSection.classList.add('hidden');
      signupSection.classList.add('hidden');
    }
    function showLogin() {
      welcomeSection.classList.add('hidden');
      appSection.classList.remove('hidden');
      loginSection.classList.remove('hidden');
      signupSection.classList.add('hidden');
      meSection.classList.add('hidden');
    }
    function showSignup() {
      welcomeSection.classList.add('hidden');
      appSection.classList.remove('hidden');
      loginSection.classList.add('hidden');
      signupSection.classList.remove('hidden');
      meSection.classList.add('hidden');
    }
    function showChat() {
      welcomeSection.classList.add('hidden');
      appSection.classList.remove('hidden');
      loginSection.classList.add('hidden');
      signupSection.classList.add('hidden');
      meSection.classList.remove('hidden');
    }

    btnShowLogin.addEventListener('click', showLogin);
    btnShowSignup.addEventListener('click', showSignup);
    btnSwitchSignup.addEventListener('click', showSignup);
    btnSwitchLogin.addEventListener('click', showLogin);

    // =========================
    // HELPERS
    // =========================
    function setStatus(text) { statusBar.textContent = text || ''; }
    function saveToken(t) { token = t; localStorage.setItem('jwt', t); }
    function clearToken() { token = null; localStorage.removeItem('jwt'); }
    async function http(method, path, body) {
      const headers = { 'Content-Type': 'application/json' };
      if (token) headers['Authorization'] = 'Bearer ' + token;
      const res = await fetch(API_BASE + path, {
        method, headers, body: body ? JSON.stringify(body) : undefined
      });
      if (!res.ok) {
        let msg = `${res.status} ${res.statusText}`;
        try { msg = (await res.text()) || msg; } catch {}
        throw new Error(msg);
      }
      const ct = res.headers.get('content-type') || '';
      return ct.includes('application/json') ? res.json() : null;
    }
    function fmtTime(ts) {
      if (!ts) return '';
      const d = new Date(ts);
      return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    }
    function scrollToBottom() {
      setTimeout(() => {
        const scroller = messagesBox.parentElement;
        scroller.scrollTop = scroller.scrollHeight;
      }, 0);
    }
    function resetChatState() {
      messages = [];
      currentPage = 0;
      lastLoadedPage = -1;
      isLastPage = false;
      messagesBox.innerHTML = '';
      btnLoadMore.classList.add('hidden');
    }
    function dedupeById(arr) {
      const map = new Map();
      for (const m of arr) map.set(m.id, m);
      return Array.from(map.values()).sort((a,b)=> new Date(a.createdAt) - new Date(b.createdAt));
    }
    // =========================
    // RENDERING
    // =========================
    function renderUsers(list) {
      usersList.innerHTML = '';
      list.forEach(u => {
        const item = document.createElement('div');
        item.className = 'user-item';
        item.onclick = () => selectPeer(u.id, u.username);
        const name = document.createElement('div');
        name.className = 'user-name';
        name.textContent = u.username;
        item.appendChild(name);
        usersList.appendChild(item);
      });
    }
    function renderMessages() {
      messagesBox.innerHTML = '';
      messages.forEach(m => {
        const mine = m.senderId === me.id;
        const wrapper = document.createElement('div');
        wrapper.className = 'msg ' + (mine ? 'mine' : 'theirs');
        const content = document.createElement('div');
        content.className = 'content';
        content.textContent = m.content;
        const meta = document.createElement('div');
        meta.className = 'meta';
        const time = document.createElement('span');
        time.textContent = fmtTime(m.createdAt);
        meta.appendChild(time);
        if (mine) {
          const status = document.createElement('span');
          if (m.readAt) status.textContent = 'âœ“âœ“ Read';
          else if (m.deliveredAt) status.textContent = 'âœ“ Delivered';
          else status.textContent = 'â€¢ Sent';
          meta.appendChild(status);
        }
        const actions = document.createElement('div');
        actions.className = 'actions';
        const del = document.createElement('button');
        del.className = 'action-btn';
        del.textContent = 'ðŸ—‘ï¸';
        del.title = 'Delete for me';
        del.onclick = () => deleteMessage(m.id);
        actions.appendChild(del);
        wrapper.appendChild(actions);
        wrapper.appendChild(content);
        wrapper.appendChild(meta);
        messagesBox.appendChild(wrapper);
      });
      scrollToBottom();
    }
    // =========================
    // BACKEND INTEGRATION
    // =========================
    async function signup() {
      try {
        setStatus('Signing up...');
        const resp = await http('POST', '/api/auth/signup', {
          username: el('signup-username').value.trim(),
          email: el('signup-email').value.trim(),
          password: el('signup-password').value
        });
        saveToken(resp.token);
        await onAuthenticated();
      } catch (e) {
        setStatus('Signup failed: ' + e.message);
      }
    }
    async function login() {
      try {
        setStatus('Logging in...');
        const resp = await http('POST', '/api/auth/login', {
          username: el('login-username').value.trim(),
          password: el('login-password').value
        });
        saveToken(resp.token);
        await onAuthenticated();
      } catch (e) {
        setStatus('Login failed: ' + e.message);
      }
    }
    async function onAuthenticated() {
      me = await http('GET', '/api/users/me');
      meUsername.textContent = '@' + me.username;
      meEmail.textContent = me.email || '';
      showChat();
      messageInput.disabled = false;
      btnSend.disabled = false;
      connectWS();
      await searchUsers('');
    }
    function logout() {
      try { if (stomp && stomp.connected) stomp.disconnect(() => {}); } catch {}
      stomp = null;
      me = null;
      currentPeer = null;
      clearToken();
      messages = [];
      messagesBox.innerHTML = '';
      chatTitle.textContent = 'Select a user';
      typingIndicator.classList.add('hidden');
      messageInput.value = '';
      messageInput.disabled = true;
      btnSend.disabled = true;
      meSection.classList.add('hidden');
      showLogin();
      setStatus('Logged out');
    }
    async function searchUsers(q) {
      const list = await http('GET', '/api/users/search?q=' + encodeURIComponent(q || ''));
      renderUsers(list.filter(u => u.id !== me.id));
    }
    async function selectPeer(id, username) {
      currentPeer = { id, username };
      chatTitle.textContent = '@' + username;
      resetChatState();
      await loadConversationPage(0);
    }
    async function loadConversationPage(page) {
      if (!currentPeer) return;
      if (page === lastLoadedPage) return;
      setStatus('Loading messages...');
      const resp = await http('GET',
        `/api/messages/conversation/${currentPeer.id}?page=${page}&size=${PAGE_SIZE}`
      );
      lastLoadedPage = page;
      isLastPage = resp.last;
      messages = dedupeById(messages.concat(resp.content));
      renderMessages();
      setStatus('');
      const hide = (resp.page === 0 && resp.content.length === 0) || isLastPage;
      btnLoadMore.classList.toggle('hidden', hide);
      const toMark = [];
      for (const m of messages) {
        const incoming = (m.senderId === currentPeer.id && m.receiverId === me.id);
        if (incoming && !m.readAt) toMark.push(m.id);
      }
      if (toMark.length > 0) {
        await markRead(toMark);
      }
    }
    async function sendMessage() {
      if (!currentPeer) return;
      const text = messageInput.value.trim();
      if (!text) return;
      try {
        const dto = await http('POST', '/api/messages', {
          receiverId: currentPeer.id,
          content: text
        });
        messageInput.value = '';
        messages.push(dto);
        messages = dedupeById(messages);
        renderMessages();
      } catch (e) {
        setStatus('Send failed: ' + e.message);
      }
    }
    async function deleteMessage(id) {
      try {
        await http('DELETE', '/api/messages/' + id);
        messages = messages.filter(m => m.id !== id);
        renderMessages();
      } catch (e) {
        setStatus('Delete failed: ' + e.message);
      }
    }
    async function markRead(ids) {
      try {
        await http('POST', '/api/messages/read', { messageIds: ids });
        const now = new Date().toISOString();
        for (const m of messages) {
          if (ids.includes(m.id)) m.readAt = now;
        }
        renderMessages();
      } catch {}
    }
    // =========================
    // WEBSOCKET
    // =========================
    function connectWS() {
      const sock = new SockJS(WS_URL);
      stomp = Stomp.over(sock);
      stomp.debug = null;
      stomp.connect(
        { Authorization: 'Bearer ' + token },
        onWsConnected,
        (err) => setStatus('WS error: ' + (err && err.body ? err.body : 'disconnected'))
      );
    }
    function onWsConnected() {
      setStatus('Connected');
      stomp.subscribe('/user/queue/messages', (frame) => {
        const msg = JSON.parse(frame.body);
        if (!currentPeer) return;
        const isThisChat =
          (msg.senderId === me.id && msg.receiverId === currentPeer.id) ||
          (msg.senderId === currentPeer.id && msg.receiverId === me.id);
        if (isThisChat) {
          messages = dedupeById(messages.concat([msg]));
          renderMessages();
          if (msg.senderId === currentPeer.id && msg.receiverId === me.id && !msg.readAt) {
            markRead([msg.id]);
          }
        }
      });
      stomp.subscribe('/user/queue/read-receipts', (frame) => {
        const receipt = JSON.parse(frame.body);
        let changed = false;
        for (const m of messages) {
          if (receipt.messageIds.includes(m.id)) {
            m.readAt = receipt.readAt || new Date().toISOString();
            changed = true;
          }
        }
        if (changed) renderMessages();
      });
      stomp.subscribe('/user/queue/typing', (frame) => {
        const t = JSON.parse(frame.body);
        if (!currentPeer || t.fromUserId !== currentPeer.id) return;
        if (t.typing) {
          typingIndicator.classList.remove('hidden');
          if (typingTimer) clearTimeout(typingTimer);
          typingTimer = setTimeout(() => typingIndicator.classList.add('hidden'), 2000);
        } else {
          typingIndicator.classList.add('hidden');
        }
      });
    }
    function sendTyping(typing) {
      if (!stomp || !stomp.connected || !currentPeer) return;
      const payload = { toUserId: currentPeer.id, typing: !!typing };
      stomp.send('/app/typing', {}, JSON.stringify(payload));
    }
    // =========================
    // EVENTS
    // =========================
    btnSignup.addEventListener('click', async () => {
      await signup();
    });
    btnLogin.addEventListener('click', async () => {
      await login();
    });
    btnLogout.addEventListener('click', logout);
    searchInput.addEventListener('input', (e) => {
      const q = e.target.value.trim();
      if (searchInput._t) clearTimeout(searchInput._t);
      searchInput._t = setTimeout(() => searchUsers(q), 250);
    });
    btnLoadMore.addEventListener('click', async () => {
      if (isLastPage) return;
      currentPage += 1;
      await loadConversationPage(currentPage);
      btnLoadMore.classList.toggle('hidden', isLastPage);
    });
    btnSend.addEventListener('click', sendMessage);
    messageInput.addEventListener('input', () => {
      sendTyping(true);
      if (messageInput._typingT) clearTimeout(messageInput._typingT);
      messageInput._typingT = setTimeout(() => sendTyping(false), 1200);
    });
    messageInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        sendMessage();
      }
    });
    // =========================
    // BOOT
    // =========================
    (async function boot() {
      const t = localStorage.getItem('jwt');
      if (t) {
        saveToken(t);
        try {
          await onAuthenticated();
          showChat();
        } catch {
          clearToken();
          showLogin();
          setStatus('Session expired. Please login.');
        }
      } else {
        showWelcome();
      }
    })();
  </script>
</body>
</html>