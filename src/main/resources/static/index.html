// ...existing code...
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>QuickChat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
  <style>
    :root {
      --apple-bg: linear-gradient(135deg, #f5f5f7 0%, #e3e9f7 100%);
      --apple-panel: rgba(255,255,255,0.85);
      --apple-card: rgba(255,255,255,0.7);
      --accent: #0071e3;
      --accent-hover: #005bb5;
      --accent-2: #3b82f6;
      --danger: #ef4444;
      --text: #1d1d1f;
      --muted: #86868b;
      --mine: #0071e3;
      --theirs: #e5e5ea;
      --border: #d2d2d7;
      --radius: 18px;
      --shadow: 0 4px 24px rgba(0,0,0,0.10);
      --blur: 18px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: var(--apple-bg);
      color: var(--text);
      min-height: 100vh;
      transition: background 0.5s;
    }
    .apple-nav {
      background: var(--apple-panel);
      box-shadow: var(--shadow);
      padding: 0 20px;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 22px;
      font-weight: 700;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 40;
      backdrop-filter: blur(var(--blur));
      letter-spacing: -0.03em;
    }
    .apple-logo {
      color: var(--accent);
      font-family: inherit;
      font-weight: 700;
      font-size: 20px;
      letter-spacing: -0.04em;
      text-shadow: 0 2px 8px #0071e322;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .mobile-menu-btn {
      display: none;
      background: transparent;
      border: none;
      font-size: 22px;
      cursor: pointer;
      color: var(--muted);
    }

    #app {
      display: grid;
      grid-template-columns: 340px 1fr;
      width: 100%;
      min-height: calc(100vh - 56px);
      max-width: 1400px;
      margin: 0 auto;
      background: transparent;
      transition: opacity 0.5s;
    }
    .sidebar {
      background: transparent;
      border-right: 1px solid var(--border);
      padding: 32px 24px 24px 24px;
      overflow-y: auto;
      min-height: calc(100vh - 56px);
      transition: transform 0.25s ease;
    }
    .card {
      background: var(--apple-card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      padding: 24px;
      margin-bottom: 32px;
      transition: box-shadow 0.2s, background 0.3s;
      animation: fadeinUp 0.7s;
      backdrop-filter: blur(var(--blur));
    }
    @keyframes fadeinUp {
      from { opacity: 0; transform: translateY(40px);}
      to { opacity: 1; transform: translateY(0);}
    }
    .card:focus-within, .card:hover {
      box-shadow: 0 8px 32px rgba(0,0,0,0.14);
      background: rgba(255,255,255,0.85);
    }
    .me-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .me-username { font-weight: 700; font-size: 18px; }
    .me-email { color: var(--muted); font-size: 13px; }
    .field { margin: 12px 0; }
    .field label { display: block; font-size: 13px; color: var(--muted); margin-bottom: 6px; }
    .field input, .field textarea {
      width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border);
      background: #f9f9fa; color: var(--text); font-size: 16px;
      transition: border 0.2s, box-shadow 0.2s;
      box-shadow: 0 1px 2px rgba(0,0,0,0.03);
    }
    .field input:focus, .field textarea:focus { border-color: var(--accent); outline: none; box-shadow: 0 2px 8px #0071e322;}
    .btn {
      border: none; padding: 12px 20px; border-radius: 10px; cursor: pointer; color: #fff;
      background: var(--accent-2); font-size: 16px; font-weight: 500;
      transition: background 0.15s, box-shadow 0.2s, transform 0.2s;
      margin-top: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      position: relative;
      overflow: hidden;
    }
    .btn.primary { background: var(--accent); }
    .btn.primary:hover { background: var(--accent-hover); transform: translateY(-2px) scale(1.04);}
    .btn.danger { background: var(--danger); }
    .btn.ghost {
      background: transparent; border: 1px solid var(--border); color: var(--muted);
    }
    .btn.small { font-size: 13px; padding: 7px 12px; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .divider { text-align: center; color: var(--muted); font-size: 13px; margin: 12px 0; }
    .list { display: grid; gap: 10px; }
    .user-item {
      background: #f9f9fa; border: 1px solid var(--border); padding: 14px; border-radius: 12px; cursor: pointer;
      transition: border 0.2s, box-shadow 0.2s, background 0.2s;
      font-size: 16px;
      animation: fadeinUp 0.5s;
    }
    .user-item:hover { border-color: var(--accent); box-shadow: 0 2px 8px rgba(0,0,0,0.04); background: #e3e9f7;}
    .user-name { font-weight: 600; }
    .main { display: grid; grid-template-rows: auto 1fr auto; background: transparent;}
    .chat-header {
      border-bottom: 1px solid var(--border);
      padding: 20px 24px; display: flex; align-items: center; justify-content: space-between;
      background: var(--apple-panel);
      font-size: 20px;
      font-weight: 600;
      border-radius: 0 0 var(--radius) var(--radius);
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 20;
      backdrop-filter: blur(var(--blur));
    }
    .chat-header .left { display:flex; align-items:center; gap:12px; }
    .chat-title { font-weight: 700; font-size: 18px; }
    .typing { color: var(--muted); font-size: 14px; margin-top: 4px; }
    .status { color: var(--muted); font-size: 14px; }
    .messages-area {
      padding: 24px 32px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px;
      background: transparent;
      min-height: 400px;
      animation: fadeinUp 0.7s;
    }
    #btn-load-more { align-self: center; }
    .messages { display: flex; flex-direction: column; gap: 12px; }
    .msg {
      max-width: 70%; padding: 14px 18px; border-radius: var(--radius);
      display: inline-flex; flex-direction: column; gap: 8px; position: relative;
      font-size: 16px;
      box-shadow: var(--shadow);
      word-break: break-word;
      animation: fadeinUp 0.5s;
      background: rgba(255,255,255,0.8);
      backdrop-filter: blur(4px);
    }
    .msg.mine { align-self: flex-end; background: var(--mine); color: #fff; }
    .msg.theirs { align-self: flex-start; background: var(--theirs); color: var(--text);}
    .msg .meta { font-size: 12px; color: #e2f1ff; opacity: 0.9; display: flex; gap: 8px; align-items: center; }
    .msg.mine .meta { color: #d2eaff; }
    .msg.theirs .meta { color: var(--muted);}
    .msg .actions {
      position: absolute; top: -8px; right: -8px; display: none;
    }
    .msg:hover .actions { display: flex; }
    .msg .action-btn {
      background: #0008; border: 1px solid var(--border); color: #fff; font-size: 12px;
      padding: 4px 8px; border-radius: 10px; cursor: pointer;
      box-shadow: 0 1px 2px rgba(0,0,0,0.08);
    }
    .msg .content { white-space: pre-wrap; }
    .msg .status-dot { font-size: 12px; opacity: 0.9; }
    .composer {
      display: grid; grid-template-columns: 1fr auto auto; gap: 12px; padding: 24px 32px; border-top: 1px solid var(--border);
      background: var(--apple-panel); border-radius: var(--radius) var(--radius) 0 0; box-shadow: var(--shadow);
      animation: fadeinUp 0.7s;
      position: relative;
      backdrop-filter: blur(var(--blur));
    }
    .composer textarea {
      width: 100%; padding: 14px; border-radius: 10px; border: 1px solid var(--border);
      background: #f9f9fa; color: var(--text); font-size: 16px;
      transition: border 0.2s; resize: none; overflow: auto; min-height: 44px;
    }
    .composer textarea:focus { border-color: var(--accent); outline: none; }
    .emoji-picker {
      position: absolute;
      bottom: 60px;
      right: 40px;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      padding: 10px;
      display: none;
      z-index: 100;
      width: 260px;
      max-height: 220px;
      overflow-y: auto;
      font-size: 22px;
      gap: 8px;
      flex-wrap: wrap;
    }
    .emoji-picker span {
      cursor: pointer;
      padding: 4px;
      border-radius: 6px;
      transition: background 0.15s;
      display: inline-block;
    }
    .emoji-picker span:hover {
      background: #f0f0f0;
    }
    .welcome-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: calc(100vh - 56px);
      background: var(--apple-bg);
      animation: fadeinUp 1.2s;
    }
    .welcome-title {
      font-size: 60px;
      font-weight: 800;
      color: var(--accent);
      margin-bottom: 18px;
      margin-top: 60px;
      letter-spacing: -0.03em;
      text-shadow: 0 2px 16px #0071e322;
      animation: fadeinUp 1.2s;
    }
    .welcome-desc {
      font-size: 24px;
      color: var(--muted);
      margin-bottom: 32px;
      animation: fadeinUp 1.5s;
      text-align: center;
      max-width: 600px;
    }
    .welcome-btns {
      display: flex;
      gap: 18px;
      animation: fadeinUp 1.7s;
    }

    /* TOAST */
    .toast {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 28px;
      background: rgba(30,30,30,0.95);
      color: #fff;
      padding: 10px 16px;
      border-radius: 10px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      font-size: 14px;
      z-index: 60;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease, transform 0.25s ease;
    }
    .toast.show { opacity: 1; pointer-events: auto; transform: translateX(-50%) translateY(-4px); }

    /* MOBILE / RESPONSIVE */
    .mobile-overlay {
      position: fixed;
      inset: 56px 0 0 0;
      background: rgba(0,0,0,0.4);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease;
      z-index: 30;
    }
    .mobile-overlay.show {
      opacity: 1;
      pointer-events: auto;
    }
    @media (max-width: 900px) {
      #app { grid-template-columns: 1fr; max-width: 100%; }
      .sidebar {
        position: fixed;
        left: -320px;
        top: 56px;
        width: 300px;
        height: calc(100vh - 56px);
        background: var(--apple-card);
        border-right: 1px solid var(--border);
        box-shadow: 0 8px 32px rgba(0,0,0,0.14);
        z-index: 35;
        padding: 20px;
      }
      .sidebar.open { left: 0; }
      .mobile-menu-btn { display: inline-block; }
      .chat-header { padding: 12px 16px; }
      .chat-title { font-size: 18px; }
      .messages-area { padding: 16px; min-height: 60vh; }
      .composer { padding: 12px 16px; grid-template-columns: 1fr auto auto; }
      .emoji-picker { right: 16px; bottom: 70px; width: 200px; max-height: 180px; }
      .user-item { font-size: 15px; padding: 12px; }
      .welcome-title { font-size: 38px; }
      .welcome-desc { font-size: 18px; }
      .apple-nav { padding: 0 12px; }
    }
    .hidden { display: none !important; }
    ::-webkit-scrollbar {
      width: 8px;
      background: var(--apple-bg);
    }
    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <nav class="apple-nav">
    <div class="left" style="display:flex;align-items:center;gap:12px;">
      <button id="btn-toggle-sidebar" class="mobile-menu-btn" aria-label="Open menu" type="button">â˜°</button>
      <span class="apple-logo">QuickChat</span>
    </div>
    <div style="font-size:13px;color:var(--muted);font-weight:500;">Fast & simple messaging</div>
  </nav>

  <div id="mobile-overlay" class="mobile-overlay hidden" aria-hidden="true"></div>

  <div id="welcome-section" class="welcome-section">
    <div class="welcome-title">Welcome to QuickChat</div>
    <div class="welcome-desc">Connect, chat, and share emojis instantly.<br>Start by logging in or creating an account.</div>
    <div class="welcome-btns">
      <button id="btn-show-login" class="btn primary" type="button">Login</button>
      <button id="btn-show-signup" class="btn" type="button">Signup</button>
    </div>
  </div>

  <div id="app" class="hidden" aria-live="polite">
    <!-- LEFT SIDEBAR -->
    <aside id="sidebar" class="sidebar" aria-label="Sidebar">
      <div id="login-section" class="card hidden" aria-hidden="true">
        <h3 style="font-weight:600;font-size:20px;margin-bottom:8px;">Login</h3>
        <div class="field">
          <label for="login-username">Username</label>
          <input id="login-username" type="text" placeholder="e.g. aryan" />
        </div>
        <div class="field">
          <label for="login-password">Password</label>
          <input id="login-password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" />
        </div>
        <button id="btn-login" class="btn primary" type="button">Login</button>
        <div class="divider"><button id="btn-switch-signup" class="btn ghost small" type="button">Create account</button></div>
      </div>
      <div id="signup-section" class="card hidden" aria-hidden="true">
        <h3 style="font-weight:600;font-size:20px;margin-bottom:8px;">Signup</h3>
        <div class="field">
          <label for="signup-username">Username</label>
          <input id="signup-username" type="text" placeholder="unique handle" />
        </div>
        <div class="field">
          <label for="signup-email">Email</label>
          <input id="signup-email" type="email" placeholder="you@example.com" />
        </div>
        <div class="field">
          <label for="signup-password">Password</label>
          <input id="signup-password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" />
        </div>
        <button id="btn-signup" class="btn primary" type="button">Create account</button>
        <div class="divider"><button id="btn-switch-login" class="btn ghost small" type="button">Back to login</button></div>
      </div>

      <div id="me-section" class="card hidden" aria-hidden="true">
        <div class="me-row">
          <div>
            <div class="me-username" id="me-username">@me</div>
            <div class="me-email" id="me-email"></div>
          </div>
          <button id="btn-logout" class="btn danger small" type="button">Logout</button>
        </div>
        <div class="field">
          <label for="search-input">Search users</label>
          <input id="search-input" type="text" placeholder="type to search..." />
        </div>
        <div id="users-list" class="list" role="list"></div>
      </div>
    </aside>

    <!-- MAIN CHAT AREA -->
    <main class="main" role="main">
      <header class="chat-header">
        <div class="left">
          <div id="chat-title" class="chat-title">Select a user</div>
          <div id="typing-indicator" class="typing hidden" aria-hidden="true">typingâ€¦</div>
        </div>
        <div id="status" class="status" aria-live="polite"></div>
      </header>

      <section class="messages-area" aria-live="polite">
        <button id="btn-load-more" class="btn ghost small hidden" type="button">Load more</button>
        <div id="messages" class="messages" role="list"></div>
      </section>

      <footer class="composer" role="contentinfo">
        <textarea id="message-input" rows="1" placeholder="Type a messageâ€¦" disabled aria-label="Message input"></textarea>
        <button id="btn-emoji" class="btn ghost" title="Insert emoji" type="button" aria-label="Open emoji picker" style="padding:0 12px;font-size:22px;">ðŸ˜Š</button>
        <button id="btn-send" class="btn primary" disabled type="button" aria-label="Send message">Send</button>
        <div id="emoji-picker" class="emoji-picker" aria-hidden="true"></div>
      </footer>
    </main>
  </div>

  <div id="toast" class="toast" role="status" aria-live="assertive"></div>

  <script>
    // =========================
    // CONFIG
    // =========================
    const SAME_ORIGIN = true;
    const API_BASE = SAME_ORIGIN ? '' : 'http://localhost:8080';
    const WS_URL   = SAME_ORIGIN ? '/ws' : 'http://localhost:8080/ws';
    const PAGE_SIZE = 20;

    // =========================
    // STATE
    // =========================
    let token = null;
    let stomp = null;
    let sock = null;
    let me = null;
    let currentPeer = null;
    let currentPage = 0;
    let lastLoadedPage = -1;
    let isLastPage = false;
    let messages = [];
    let typingTimer = null;

    // WS reconnect/backoff
    let wsBackoff = 500;
    const wsMaxBackoff = 30000;
    let wsReconnectTimer = null;

    // =========================
    // DOM
    // =========================
    const el = (id) => document.getElementById(id);
    const welcomeSection = el('welcome-section');
    const appSection = el('app');
    const loginSection = el('login-section');
    const signupSection = el('signup-section');
    const btnShowLogin = el('btn-show-login');
    const btnShowSignup = el('btn-show-signup');
    const btnSwitchSignup = el('btn-switch-signup');
    const btnSwitchLogin = el('btn-switch-login');
    const btnLogin       = el('btn-login');
    const btnSignup      = el('btn-signup');
    const btnLogout      = el('btn-logout');
    const meSection      = el('me-section');
    const meUsername     = el('me-username');
    const meEmail        = el('me-email');
    const searchInput    = el('search-input');
    const usersList      = el('users-list');
    const chatTitle      = el('chat-title');
    const typingIndicator= el('typing-indicator');
    const statusBar      = el('status');
    const btnLoadMore    = el('btn-load-more');
    const messagesBox    = el('messages');
    const messageInput   = el('message-input');
    const btnSend        = el('btn-send');
    const emojiBtn       = el('btn-emoji');
    const emojiPicker    = el('emoji-picker');
    const sidebar        = el('sidebar');
    const btnToggleSidebar = el('btn-toggle-sidebar');
    const mobileOverlay  = el('mobile-overlay');
    const toastEl        = el('toast');

    // =========================
    // EMOJI PICKER (original set)
    // =========================
    const EMOJIS = [
      "ðŸ˜€","ðŸ˜","ðŸ˜‚","ðŸ¤£","ðŸ˜ƒ","ðŸ˜„","ðŸ˜…","ðŸ˜†","ðŸ˜‰","ðŸ˜Š","ðŸ˜‹","ðŸ˜Ž","ðŸ˜","ðŸ˜˜","ðŸ¥°","ðŸ˜—","ðŸ˜™","ðŸ˜š",
      "ðŸ™‚","ðŸ¤—","ðŸ¤©","ðŸ¤”","ðŸ¤¨","ðŸ˜","ðŸ˜‘","ðŸ˜¶","ðŸ™„","ðŸ˜","ðŸ˜£","ðŸ˜¥","ðŸ˜®","ðŸ¤","ðŸ˜¯","ðŸ˜ª","ðŸ˜«","ðŸ¥±",
      "ðŸ˜´","ðŸ˜Œ","ðŸ˜›","ðŸ˜œ","ðŸ˜","ðŸ¤¤","ðŸ˜’","ðŸ˜“","ðŸ˜”","ðŸ˜•","ðŸ™ƒ","ðŸ¤‘","ðŸ˜²","â˜¹ï¸","ðŸ™","ðŸ˜–","ðŸ˜ž","ðŸ˜Ÿ",
      "ðŸ˜¤","ðŸ˜¢","ðŸ˜­","ðŸ˜¦","ðŸ˜§","ðŸ˜¨","ðŸ˜©","ðŸ¤¯","ðŸ˜¬","ðŸ˜°","ðŸ˜±","ðŸ¥µ","ðŸ¥¶","ðŸ˜³","ðŸ¤ª","ðŸ˜µ","ðŸ˜¡","ðŸ˜ ",
      "ðŸ¤¬","ðŸ˜·","ðŸ¤’","ðŸ¤•","ðŸ¤¢","ðŸ¤®","ðŸ¥´","ðŸ˜‡","ðŸ¥³","ðŸ¥º","ðŸ¤ ","ðŸ¤¡","ðŸ¤¥","ðŸ¤«","ðŸ¤­","ðŸ§"
    ];
    function renderEmojiPicker() {
      emojiPicker.innerHTML = '';
      EMOJIS.forEach(e => {
        const span = document.createElement('span');
        span.textContent = e;
        span.onclick = () => {
          messageInput.value += e;
          emojiPicker.style.display = 'none';
          messageInput.focus();
          autosizeTextarea();
        };
        emojiPicker.appendChild(span);
      });
    }
    emojiBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      if (emojiPicker.style.display === 'block') {
        emojiPicker.style.display = 'none';
        emojiPicker.setAttribute('aria-hidden', 'true');
      } else {
        renderEmojiPicker();
        emojiPicker.style.display = 'block';
        emojiPicker.setAttribute('aria-hidden', 'false');
      }
    });
    document.addEventListener('click', (e) => {
      if (!emojiPicker.contains(e.target) && e.target !== emojiBtn) {
        emojiPicker.style.display = 'none';
        emojiPicker.setAttribute('aria-hidden', 'true');
      }
    });

    // =========================
    // TOAST
    // =========================
    let toastTimer = null;
    function showToast(msg, ms = 3500) {
      if (!toastEl) return;
      toastEl.textContent = msg;
      toastEl.classList.add('show');
      if (toastTimer) clearTimeout(toastTimer);
      toastTimer = setTimeout(() => {
        toastEl.classList.remove('show');
      }, ms);
    }

    // =========================
    // MOBILE SIDEBAR HANDLING
    // =========================
    function openSidebar() {
      sidebar.classList.add('open');
      mobileOverlay.classList.remove('hidden');
      mobileOverlay.classList.add('show');
      mobileOverlay.setAttribute('aria-hidden', 'false');
    }
    function closeSidebar() {
      sidebar.classList.remove('open');
      mobileOverlay.classList.remove('show');
      mobileOverlay.classList.add('hidden');
      mobileOverlay.setAttribute('aria-hidden', 'true');
    }
    btnToggleSidebar.addEventListener('click', () => {
      if (sidebar.classList.contains('open')) closeSidebar(); else openSidebar();
    });
    mobileOverlay.addEventListener('click', closeSidebar);

    function closeSidebarIfMobile() {
      if (window.innerWidth <= 900) closeSidebar();
    }

    // =========================
    // PAGE FLOW
    // =========================
    function showWelcome() {
      welcomeSection.classList.remove('hidden');
      appSection.classList.add('hidden');
      loginSection.classList.add('hidden');
      signupSection.classList.add('hidden');
    }
    function showLogin() {
      welcomeSection.classList.add('hidden');
      appSection.classList.remove('hidden');
      loginSection.classList.remove('hidden');
      signupSection.classList.add('hidden');
      meSection.classList.add('hidden');
    }
    function showSignup() {
      welcomeSection.classList.add('hidden');
      appSection.classList.remove('hidden');
      loginSection.classList.add('hidden');
      signupSection.classList.remove('hidden');
      meSection.classList.add('hidden');
    }
    function showChat() {
      welcomeSection.classList.add('hidden');
      appSection.classList.remove('hidden');
      loginSection.classList.add('hidden');
      signupSection.classList.add('hidden');
      meSection.classList.remove('hidden');
    }

    btnShowLogin.addEventListener('click', showLogin);
    btnShowSignup.addEventListener('click', showSignup);
    btnSwitchSignup.addEventListener('click', showSignup);
    btnSwitchLogin.addEventListener('click', showLogin);

    // =========================
    // HELPERS
    // =========================
    function setStatus(text) { statusBar.textContent = text || ''; }
    function saveToken(t) { token = t; localStorage.setItem('jwt', t); }
    function clearToken() { token = null; localStorage.removeItem('jwt'); }
    async function http(method, path, body) {
      const headers = { 'Content-Type': 'application/json' };
      if (token) headers['Authorization'] = 'Bearer ' + token;
      const res = await fetch(API_BASE + path, {
        method, headers, body: body ? JSON.stringify(body) : undefined
      });
      if (!res.ok) {
        let msg = `${res.status} ${res.statusText}`;
        try { msg = (await res.text()) || msg; } catch {}
        throw new Error(msg);
      }
      const ct = res.headers.get('content-type') || '';
      return ct.includes('application/json') ? res.json() : null;
    }
    function fmtTime(ts) {
      if (!ts) return '';
      const d = new Date(ts);
      return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    }
    function scrollToBottom() {
      setTimeout(() => {
        const scroller = messagesBox.parentElement;
        scroller.scrollTop = scroller.scrollHeight;
      }, 0);
    }
    function resetChatState() {
      messages = [];
      currentPage = 0;
      lastLoadedPage = -1;
      isLastPage = false;
      messagesBox.innerHTML = '';
      btnLoadMore.classList.add('hidden');
    }
    function dedupeById(arr) {
      const map = new Map();
      for (const m of arr) map.set(m.id, m);
      return Array.from(map.values()).sort((a,b)=> new Date(a.createdAt) - new Date(b.createdAt));
    }

    // =========================
    // RENDERING
    // =========================
    function renderUsers(list) {
      usersList.innerHTML = '';
      list.forEach(u => {
        const item = document.createElement('div');
        item.className = 'user-item';
        item.onclick = () => { selectPeer(u.id, u.username); closeSidebarIfMobile(); };
        item.setAttribute('role','listitem');
        const name = document.createElement('div');
        name.className = 'user-name';
        name.textContent = u.username;
        item.appendChild(name);
        usersList.appendChild(item);
      });
    }
    function renderMessages() {
      messagesBox.innerHTML = '';
      messages.forEach(m => {
        const mine = m.senderId === me?.id;
        const wrapper = document.createElement('div');
        wrapper.className = 'msg ' + (mine ? 'mine' : 'theirs');
        wrapper.setAttribute('role','listitem');
        const content = document.createElement('div');
        content.className = 'content';
        content.textContent = m.content;
        const meta = document.createElement('div');
        meta.className = 'meta';
        const time = document.createElement('span');
        time.textContent = fmtTime(m.createdAt);
        meta.appendChild(time);

        if (m.sending) {
          const s = document.createElement('span');
          s.className = 'status-dot';
          s.textContent = ' â€¢ Sendingâ€¦';
          meta.appendChild(s);
        } else if (m.failed) {
          const f = document.createElement('span');
          f.className = 'status-dot';
          f.textContent = ' â€¢ Failed';
          f.style.color = 'var(--danger)';
          meta.appendChild(f);
        } else if (mine) {
          const status = document.createElement('span');
          if (m.readAt) status.textContent = ' âœ“âœ“ Read';
          else if (m.deliveredAt) status.textContent = ' âœ“ Delivered';
          else status.textContent = ' â€¢ Sent';
          meta.appendChild(status);
        }

        const actions = document.createElement('div');
        actions.className = 'actions';
        const del = document.createElement('button');
        del.className = 'action-btn';
        del.textContent = 'ðŸ—‘ï¸';
        del.title = 'Delete for me';
        del.type = 'button';
        del.onclick = () => deleteMessage(m.id);
        actions.appendChild(del);

        wrapper.appendChild(actions);
        wrapper.appendChild(content);
        wrapper.appendChild(meta);
        messagesBox.appendChild(wrapper);
      });
      scrollToBottom();
    }

    // =========================
    // BACKEND INTEGRATION
    // =========================
    async function signup() {
      try {
        setStatus('Signing up...');
        const resp = await http('POST', '/api/auth/signup', {
          username: el('signup-username').value.trim(),
          email: el('signup-email').value.trim(),
          password: el('signup-password').value
        });
        saveToken(resp.token);
        await onAuthenticated();
        closeSidebarIfMobile();
        showToast('Signed up');
      } catch (e) {
        setStatus('');
        showToast('Signup failed: ' + e.message);
      }
    }
    async function login() {
      try {
        setStatus('Logging in...');
        const resp = await http('POST', '/api/auth/login', {
          username: el('login-username').value.trim(),
          password: el('login-password').value
        });
        saveToken(resp.token);
        await onAuthenticated();
        closeSidebarIfMobile();
        showToast('Logged in');
      } catch (e) {
        setStatus('');
        showToast('Login failed: ' + e.message);
      }
    }
    async function onAuthenticated() {
      me = await http('GET', '/api/users/me');
      meUsername.textContent = '@' + me.username;
      meEmail.textContent = me.email || '';
      showChat();
      messageInput.disabled = false;
      btnSend.disabled = false;
      connectWS();
      await searchUsers('');
    }
    function logout() {
      try { if (stomp && stomp.connected) stomp.disconnect(() => {}); } catch {}
      try { if (sock && sock.close) sock.close(); } catch {}
      stomp = null; sock = null;
      me = null;
      currentPeer = null;
      clearToken();
      messages = [];
      messagesBox.innerHTML = '';
      chatTitle.textContent = 'Select a user';
      typingIndicator.classList.add('hidden');
      messageInput.value = '';
      messageInput.disabled = true;
      btnSend.disabled = true;
      meSection.classList.add('hidden');
      showLogin();
      setStatus('Logged out');
      closeSidebar();
      showToast('Logged out');
    }
    async function searchUsers(q) {
      try {
        const list = await http('GET', '/api/users/search?q=' + encodeURIComponent(q || ''));
        renderUsers(list.filter(u => u.id !== me.id));
      } catch (e) {
        showToast('Search failed: ' + e.message);
      }
    }
    async function selectPeer(id, username) {
      currentPeer = { id, username };
      chatTitle.textContent = '@' + username;
      resetChatState();
      await loadConversationPage(0);
    }
    async function loadConversationPage(page) {
      if (!currentPeer) return;
      if (page === lastLoadedPage) return;
      setStatus('Loading messages...');
      try {
        const resp = await http('GET',
          `/api/messages/conversation/${currentPeer.id}?page=${page}&size=${PAGE_SIZE}`
        );
        lastLoadedPage = page;
        isLastPage = resp.last;
        messages = dedupeById(messages.concat(resp.content));
        renderMessages();
        setStatus('');
        const hide = (resp.page === 0 && resp.content.length === 0) || isLastPage;
        btnLoadMore.classList.toggle('hidden', hide);
        const toMark = [];
        for (const m of messages) {
          const incoming = (m.senderId === currentPeer.id && m.receiverId === me.id);
          if (incoming && !m.readAt) toMark.push(m.id);
        }
        if (toMark.length > 0) {
          await markRead(toMark);
        }
      } catch (e) {
        setStatus('');
        showToast('Load messages failed: ' + e.message);
      }
    }

    // Optimistic send
    async function sendMessage() {
      if (!currentPeer || !me) return;
      const text = messageInput.value.trim();
      if (!text) return;
      // create optimistic message
      const tmpId = 'tmp-' + Date.now() + '-' + Math.random().toString(36).slice(2,7);
      const tmpMsg = {
        id: tmpId,
        senderId: me.id,
        receiverId: currentPeer.id,
        content: text,
        createdAt: new Date().toISOString(),
        sending: true
      };
      messages.push(tmpMsg);
      messages = dedupeById(messages);
      renderMessages();
      messageInput.value = '';
      autosizeTextarea();

      try {
        const dto = await http('POST', '/api/messages', {
          receiverId: currentPeer.id,
          content: text
        });
        // replace tmp message with server dto
        messages = messages.map(m => m.id === tmpId ? dto : m);
        messages = dedupeById(messages);
        renderMessages();
      } catch (e) {
        // mark tmp message as failed
        messages = messages.map(m => m.id === tmpId ? ({ ...m, sending:false, failed:true }) : m);
        renderMessages();
        showToast('Send failed: ' + e.message);
      }
    }

    async function deleteMessage(id) {
      try {
        await http('DELETE', '/api/messages/' + id);
        messages = messages.filter(m => m.id !== id);
        renderMessages();
      } catch (e) {
        showToast('Delete failed: ' + e.message);
      }
    }
    async function markRead(ids) {
      try {
        await http('POST', '/api/messages/read', { messageIds: ids });
        const now = new Date().toISOString();
        for (const m of messages) {
          if (ids.includes(m.id)) m.readAt = now;
        }
        renderMessages();
      } catch {}
    }

    // =========================
    // WEBSOCKET (with reconnect/backoff)
    // =========================
    function connectWS() {
      if (!token) return;
      try { if (stomp && stomp.connected) return; } catch {}
      try {
        sock = new SockJS(WS_URL);
      } catch (e) {
        scheduleReconnect();
        return;
      }
      stomp = Stomp.over(sock);
      stomp.debug = null;
      sock.onclose = () => {
        setStatus('WS closed, reconnecting...');
        scheduleReconnect();
      };
      stomp.connect(
        { Authorization: 'Bearer ' + token },
        () => {
          onWsConnected();
          wsBackoff = 500;
          if (wsReconnectTimer) { clearTimeout(wsReconnectTimer); wsReconnectTimer = null; }
        },
        (err) => {
          setStatus('WS error, reconnecting...');
          scheduleReconnect();
        }
      );
    }
    function scheduleReconnect() {
      if (wsReconnectTimer) return;
      wsBackoff = Math.min(Math.max(500, wsBackoff), wsMaxBackoff);
      wsReconnectTimer = setTimeout(() => {
        wsReconnectTimer = null;
        wsBackoff = Math.min(wsBackoff * 1.8, wsMaxBackoff);
        connectWS();
      }, wsBackoff);
    }
    function onWsConnected() {
      setStatus('Connected');
      stomp.subscribe('/user/queue/messages', (frame) => {
        const msg = JSON.parse(frame.body);
        if (!currentPeer) return;
        const isThisChat =
          (msg.senderId === me.id && msg.receiverId === currentPeer.id) ||
          (msg.senderId === currentPeer.id && msg.receiverId === me.id);
        if (isThisChat) {
          // replace any optimistic message that matches (simple heuristic: same content & receiver)
          let replaced = false;
          for (let i=0;i<messages.length;i++){
            const m = messages[i];
            if (m.sending && m.content === msg.content && m.receiverId === msg.receiverId) {
              messages[i] = msg;
              replaced = true;
              break;
            }
          }
          if (!replaced) messages = dedupeById(messages.concat([msg]));
          renderMessages();
          if (msg.senderId === currentPeer.id && msg.receiverId === me.id && !msg.readAt) {
            markRead([msg.id]);
          }
        }
      });
      stomp.subscribe('/user/queue/read-receipts', (frame) => {
        const receipt = JSON.parse(frame.body);
        let changed = false;
        for (const m of messages) {
          if (receipt.messageIds.includes(m.id)) {
            m.readAt = receipt.readAt || new Date().toISOString();
            changed = true;
          }
        }
        if (changed) renderMessages();
      });
      stomp.subscribe('/user/queue/typing', (frame) => {
        const t = JSON.parse(frame.body);
        if (!currentPeer || t.fromUserId !== currentPeer.id) return;
        if (t.typing) {
          typingIndicator.classList.remove('hidden');
          if (typingTimer) clearTimeout(typingTimer);
          typingTimer = setTimeout(() => typingIndicator.classList.add('hidden'), 2000);
        } else {
          typingIndicator.classList.add('hidden');
        }
      });
    }
    function sendTyping(typing) {
      if (!stomp || !stomp.connected || !currentPeer) return;
      const payload = { toUserId: currentPeer.id, typing: !!typing };
      try { stomp.send('/app/typing', {}, JSON.stringify(payload)); } catch {}
    }

    // =========================
    // AUTOSIZE TEXTAREA
    // =========================
    function autosizeTextarea() {
      const ta = messageInput;
      if (!ta) return;
      ta.style.height = 'auto';
      const max = Math.min(window.innerHeight * 0.35, 220);
      ta.style.height = Math.min(ta.scrollHeight, max) + 'px';
    }
    (function enableAutosize() {
      if (!messageInput) return;
      messageInput.addEventListener('input', () => { autosizeTextarea(); }, { passive: true });
      messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
          autosizeTextarea();
        }
      });
      setTimeout(autosizeTextarea, 100);
    })();

    // =========================
    // EVENTS
    // =========================
    btnSignup.addEventListener('click', async () => { await signup(); });
    btnLogin.addEventListener('click', async () => { await login(); });
    btnLogout.addEventListener('click', logout);
    searchInput.addEventListener('input', (e) => {
      const q = e.target.value.trim();
      if (searchInput._t) clearTimeout(searchInput._t);
      searchInput._t = setTimeout(() => searchUsers(q), 250);
    });
    btnLoadMore.addEventListener('click', async () => {
      if (isLastPage) return;
      currentPage += 1;
      await loadConversationPage(currentPage);
      btnLoadMore.classList.toggle('hidden', isLastPage);
    });
    btnSend.addEventListener('click', sendMessage);
    messageInput.addEventListener('input', () => {
      sendTyping(true);
      if (messageInput._typingT) clearTimeout(messageInput._typingT);
      messageInput._typingT = setTimeout(() => sendTyping(false), 1200);
    });
    messageInput.addEventListener('focus', () => {
      // close sidebar on mobile to focus chat
      closeSidebarIfMobile();
    });

    // =========================
    // BOOT
    // =========================
    (async function boot() {
      const t = localStorage.getItem('jwt');
      if (t) {
        saveToken(t);
        try {
          await onAuthenticated();
          showChat();
        } catch {
          clearToken();
          showLogin();
          setStatus('Session expired. Please login.');
        }
      } else {
        showWelcome();
      }
    })();

    // Close sidebar when resizing to desktop
    window.addEventListener('resize', () => {
      if (window.innerWidth > 900) {
        sidebar.classList.remove('open');
        mobileOverlay.classList.remove('show');
        mobileOverlay.classList.add('hidden');
      }
      autosizeTextarea();
    });
  </script>
</body>
</html>
// ...existing code...
